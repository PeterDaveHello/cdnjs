window.postRobot=function(){function e(){}function n(e){var n=!1;return function(){if(!n)return n=!0,e.apply(this,arguments)}}function r(e,n){e.postMessage(JSON.stringify(n),"*")}function o(e){if(!e.window)throw new Error("Expected options.window");if(!e.name)throw new Error("Expected options.name");if(!e.response)throw new Error("Expected options.response");e.response=n(e.response);var o=Math.random().toString();if(g[o]=e,e.respond=n(function(n,r){return delete g[o],e.response(n,r)}),!e.window.postMessage)return e.respond(new Error("Target window does not have postMessage handler"));if(e.window.closed)return e.respond(new Error("Target window is closed"));e.timeout&&setTimeout(function(){e.respond(new Error("Post message response timed out after "+e.timeout+" ms"))},e.timeout);try{r(e.window,{type:c,hash:o,name:e.name,data:e.data||{}})}catch(n){e.respond(n)}setTimeout(function(){if(!e.ack)return e.respond(new Error("No ack for postMessage"))})}function t(e,n,r,t){return t||(t=r,r={}),o({window:e,name:n,response:t})}function s(n){if(!n.name)throw new Error("Expected options.name");if(m[n.name])throw new Error("Post message response handler already registered: "+n.name);if(!n.handler)throw new Error("Expected options.handler");if(m[n.name]=n,n.window)var r=setInterval(function(){n.window.closed&&(clearInterval(r),delete m[n.name],n.successOnClose?n.handler(null,null,e):n.handler(new Error("Post message target window is closed"),null,e))},50)}function a(e,n){return s({name:e,handler:n})}function i(e,n){return s({name:e,handler:n,once:!0})}function d(e){for(var o=0;o<E.length;o++)if(e.source===E[o].from)return E[o].to.postMessage(e.data,"*");var t;try{t=JSON.parse(e.data)}catch(e){return}if(t&&t.type)if(t.type===f){var s=g[t.hash];if(!s)throw new Error("No handler found for post message ack");s.ack=!0}else if(t.type===c){var a=n(function(n){return r(e.source,{type:p,ack:h,hash:t.hash,name:t.name,response:n||{}})}),i=n(function(n){return r(e.source,{type:p,ack:l,hash:t.hash,name:t.name,error:n.stack||n.toString()})}),d=m[t.name];if(!d)return i(new Error("No postmessage request handler for "+t.name));if(d.window&&d.window!==window)return;r(e.source,{type:f,hash:t.hash}),d.once&&delete m[t.name];var w;try{w=d.handler(null,t.data,function(e,n){return e?i(e):a(n)})}catch(e){return i(e)}if(w)return a(w)}else if(t.type===p){var u=g[t.hash];if(!u)throw new Error("No handler found for post message response");if(t.ack===l)return u.respond(t.error);if(t.ack===h)return u.respond(null,t.response)}}function w(e,n){E.push({from:e,to:n}),E.push({from:n,to:e})}function u(){window.removeEventListener("message",d)}if(!window.addEventListener||!window.postMessage)return window.console&&window.console.warn&&console.warn("Browser does not support window.postMessage"),{request:e,listen:e,send:e,on:e,once:e,proxy:e,destroy:e};var c="post_message_request",p="post_message_response",f="post_message_ack",h="success",l="error",m={},g={},E=[];return window.addEventListener("message",d),{request:o,listen:s,send:t,on:a,once:i,proxy:w,destroy:u}}();