!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():e.postRobot=n()}(this,function(){function e(){}function n(e){if(!e)return e;var n=!1;return function(){if(!n)return n=!0,e.apply(this,arguments)}}function o(e,n){console.error("%% send",n),e.postMessage(JSON.stringify(n),"*")}function r(e){if(!e.window)throw new Error("Expected options.window");if(!e.name)throw new Error("Expected options.name");if("string"==typeof e.window){var r=document.getElementById(e.window);if(!r)throw new Error("Expected options.window "+e.window+" to be a valid element id");if("iframe"!==r.tagName.toLowerCase())throw new Error("Expected options.window "+e.window+" to be an iframe");e.window=r.contentWindow}e.callback=n(e.callback);var t;!e.callback&&window.Promise&&(t=new window.Promise(function(n,o){e.callback=function(e,r){return e?o(e):n(r)}}));var s=e.name+"_"+Math.random().toString();if(g[s]=e,e.respond=n(function(n,o){return e.callback(n,o)}),!e.window.postMessage)return e.respond(new Error("Target window does not have postMessage handler"));if(e.window.closed)return e.respond(new Error("Target window is closed"));e.timeout&&setTimeout(function(){e.respond(new Error("Post message response timed out after "+e.timeout+" ms"))},e.timeout);try{o(e.window,{type:h,hash:s,name:e.name,data:e.data||{}})}catch(n){e.respond(n)}return setTimeout(function(){if(!e.ack)return e.respond(new Error("No ack for postMessage "+e.name))},50),t}function t(e,n,o,t){return!t&&o instanceof Function&&(t=o,o={}),r({window:e,name:n,data:o,callback:t})}function s(o){if(!o.name)throw new Error("Expected options.name");if(l[o.name])throw new Error("Post message response handler already registered: "+o.name);if(!o.handler)throw new Error("Expected options.handler");if(o.once&&(o.handler=n(o.handler)),l[o.name]=o,o.window&&o.errorOnClose)var r=setInterval(function(){o.window.closed&&(clearInterval(r),delete l[o.name],o.handler(new Error("Post message target window is closed"),null,e))},50)}function a(e,n,o){!o&&n instanceof Function&&(o=n,n={}),n.name=e,n.handler=n.handler||o,s(n)}function i(e,n,o){!o&&n instanceof Function&&(o=n,n={}),n.once=!0,a(e,n,o)}function d(e){try{e=JSON.parse(e)}catch(e){return}if(e&&e.type&&v[e.type])return e}function w(e){return!e||!1!==e.proxy&&(e.type!==h||!e.name||!l[e.name]||!1!==l[e.name].proxy)}function c(e){var n=d(e.data);if(w(n))for(var o=0;o<y.length;o++)if(e.source===y[o].from)return y[o].to.postMessage(e.data,"*");n&&(console.error("!! message",window.name,window.location.href,n.name,n),v[n.type](e,n))}function u(e,n){y.push({from:e,to:n}),y.push({from:n,to:e})}function p(e,n){for(var o=[],r=0;r<y.length;r++){var t=y[r];(t.to===e&&t.from===n||t.to===n&&t.from===e)&&o.push(t)}for(var r=0;r<o.length;r++)y.splice(y.indexOf(o[r]),1)}function f(){window.removeEventListener("message",c)}if(!window.postMessage)return window.console&&window.console.warn&&console.warn("Browser does not support window.postMessage"),{request:e,listen:e,send:e,on:e,once:e,proxy:e,unproxy:e,destroy:e};var m,h="postrobot_message_request",l={},g={},y=[];window.opener?m=window.opener:window.parent&&window!==window.parent&&(m=window.parent);var v={};return v.postrobot_message_ping=function(e,n){o(e.source,{type:"postrobot_message_pong",hash:n.hash})},v.postrobot_message_pong=function(e,n){},v.postrobot_message_ack=function(e,n){var o=g[n.hash];if(!o)throw new Error("No handler found for post message ack for message: "+n.name+" in "+window.location.href);o.ack=!0},v[h]=function(e,r){var t,s=n(function(n){return o(e.source,{type:"postrobot_message_response",ack:"success",hash:r.hash,name:r.name,response:n||{},proxy:t})}),a=n(function(n){return o(e.source,{type:"postrobot_message_response",ack:"error",hash:r.hash,name:r.name,error:n.stack||n.toString(),proxy:t})}),i=l[r.name];if(!i)return a(new Error("No postmessage request handler for "+r.name+" in "+window.location.href));if(!i.window||i.window===e.source){t=i.proxy,o(e.source,{type:"postrobot_message_ack",hash:r.hash,name:r.name,proxy:t}),i.once&&delete l[r.name];var d;try{d=i.handler(null,r.data,function(e,n){return e?a(e):s(n)})}catch(e){return a(e)}return d&&d.then instanceof Function?d.then(s,a):i.handler.length<=2?s(d):void 0}},v.postrobot_message_response=function(e,n){var o=g[n.hash];if(!o)throw new Error("No response handler found for post message response "+n.name+" in "+window.location.href);return delete g[n.hash],"error"===n.ack?o.respond(n.error):"success"===n.ack?o.respond(null,n.response):void 0},window.addEventListener?window.addEventListener("message",c):window.attachEvent("onmessage",c),{request:r,listen:s,send:t,on:a,once:i,sendToParent:function(e,n,o){return this.send(m,e,n,o)},proxy:u,unproxy:p,destroy:f,parent:m}});