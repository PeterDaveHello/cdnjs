!function(e,n){"object"==typeof exports?module.exports=n():e.postRobot=n()}(this,function(){function e(){}function n(e,n){n=Array.prototype.slice.call(n),n.unshift("[post-robot]"),n.push(window.location.href),window.name&&n.push(window.name),window.console&&(window.console[e]||(e="log"),window.console[e]&&window.console[e].apply(window.console,n))}function o(){n("log",arguments)}function r(){n("error",arguments)}function t(e){if(!e)return e;var n=!1;return function(){if(!n)return n=!0,e.apply(this,arguments)}}function s(e,n){o("#send",n.type,n.name,n),e.postMessage(JSON.stringify(n),"*")}function a(e){if(!e.name)throw new Error("Expected options.name");var n;if(!e.callback){if(!window.Promise)throw new Error("Expected callback or window.Promise");n=new window.Promise(function(n,o){e.callback=function(e,r){return e?o(e):n(r)}})}if(e.respond=t(function(o,r){return e.callback(o,r),n}),!e.window)return e.respond(new Error("Expected options.window"));if(k)e.window=window;else if("string"==typeof e.window){var o=document.getElementById(e.window);if(!o)return e.respond(new Error("Expected options.window "+e.window+" to be a valid element id"));if("iframe"!==o.tagName.toLowerCase())return e.respond(new Error("Expected options.window "+e.window+" to be an iframe"));if(e.window=o.contentWindow,!e.window)return e.respond(new Error("Expected options.window"))}var r=e.name+"_"+Math.random().toString();if(b[r]=e,e.window.closed)return e.respond(new Error("Target window is closed"));e.timeout&&setTimeout(function(){e.respond(new Error("Post message response timed out after "+e.timeout+" ms"))},e.timeout);try{s(e.window,{type:E,hash:r,name:e.name,data:e.data||{}})}catch(n){e.respond(n)}return setTimeout(function(){if(!e.ack)return e.respond(new Error("No ack for postMessage "+e.name))},50),n}function i(e,n,o,r){return!r&&o instanceof Function&&(r=o,o={}),a({window:e,name:n,data:o,callback:r})}function w(e){if(!e.name)throw new Error("Expected options.name");if(x[e.name]&&!e.override&&!k)throw new Error("Post message response handler already registered: "+e.name);if(!e.handler)throw new Error("Expected options.handler");if(e.once&&(e.handler=t(e.handler)),x[e.name]=e,e.window&&e.errorOnClose)var n=setInterval(function(){e.window.closed&&(clearInterval(n),delete x[e.name],e.handler(new Error("Post message target window is closed"),null,function(e){r("Unhandled error",e.stack||e.toString())}))},50);return{cancel:function(){delete x[e.name]}}}function d(e,n,o){return!o&&n instanceof Function&&(o=n,n={}),n.name=e,n.handler=n.handler||o,w(n)}function c(e,n,o){return!o&&n instanceof Function&&(o=n,n={}),n.once=!0,d(e,n,o)}function u(e){try{e=JSON.parse(e)}catch(e){return}if(e&&e.type&&M[e.type])return e}function p(e){return!e||!1!==e.proxy&&(e.type!==E||!e.name||!x[e.name]||!1!==x[e.name].proxy)}function f(e){var n=u(e.data);if(p(n))for(var r=0;r<_.length;r++)if(e.source===_[r].from)return o("#proxy",_[r].from,"to",_[r].to),_[r].to.postMessage(e.data,"*");n&&(o("#receive",n.type,n.name,n),M[n.type](e,n))}function l(e,n){_.push({from:e,to:n}),_.push({from:n,to:e})}function m(e,n){for(var o=[],r=0;r<_.length;r++){var t=_[r];(t.to===e&&t.from===n||t.to===n&&t.from===e)&&o.push(t)}for(var r=0;r<o.length;r++)_.splice(_.indexOf(o[r]),1)}function h(){x={},b={},_=[]}function g(){window.removeEventListener("message",f)}function y(){k=!0,g();var e=window.postMessage;window.postMessage=function(n){e.apply(this,arguments),f({source:window,data:n})}}if(!window.postMessage)return window.console&&window.console.warn&&console.warn("Browser does not support window.postMessage"),{request:e,listen:e,send:e,on:e,once:e,proxy:e,unproxy:e,destroy:e};var v,E="postrobot_message_request",x={},b={},_=[],k=!1;window.opener?v=window.opener:window.parent&&window!==window.parent&&(v=window.parent);var M={};return M.postrobot_message_ping=function(e,n){s(e.source,{type:"postrobot_message_pong",hash:n.hash})},M.postrobot_message_pong=function(e,n){},M.postrobot_message_ack=function(e,n){var o=b[n.hash];if(!o)throw new Error("No handler found for post message ack for message: "+n.name+" in "+window.location.href);o.ack=!0},M[E]=function(e,n){var o,r=t(function(r){return s(e.source,{type:"postrobot_message_response",ack:"success",hash:n.hash,name:n.name,response:r||{},proxy:o})}),a=t(function(r){return s(e.source,{type:"postrobot_message_response",ack:"error",hash:n.hash,name:n.name,error:r.stack||r.toString(),proxy:o})}),i=x[n.name];if(!i)return a(new Error("No postmessage request handler for "+n.name+" in "+window.location.href));if(!i.window||i.window===e.source){o=i.proxy,s(e.source,{type:"postrobot_message_ack",hash:n.hash,name:n.name,proxy:o}),i.once&&delete x[n.name];var w;try{w=i.handler(null,n.data,function(e,n){return e?a(e):r(n)})}catch(e){return a(e)}return w&&w.then instanceof Function?w.then(r,a):i.handler.length<=2?r(w):void 0}},M.postrobot_message_response=function(e,n){var o=b[n.hash];if(!o)throw new Error("No response handler found for post message response "+n.name+" in "+window.location.href);return delete b[n.hash],"error"===n.ack?o.respond(n.error):"success"===n.ack?o.respond(null,n.response):void 0},window.addEventListener?window.addEventListener("message",f):window.attachEvent("onmessage",f),{request:a,listen:w,send:i,on:d,once:c,sendToParent:function(e,n,o){return this.send(v,e,n,o)},proxy:l,unproxy:m,enableMockMode:y,reset:h,destroy:g,parent:v}});